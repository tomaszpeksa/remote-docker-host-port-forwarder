#!/bin/bash
# Simple docker shim - intercepts docker commands and returns canned responses
# This shim replaces the real docker command in integration test environments

SCENARIO_DIR="${SCENARIO_DIR:-/opt/rdhpf-scenarios/default}"

case "$1" in
  events)
    # Read scenario file and emit events with optional sleep between them
    while IFS= read -r line; do
      op=$(echo "$line" | jq -r '.op')
      if [ "$op" = "sleep" ]; then
        ms=$(echo "$line" | jq -r '.ms')
        sleep $(echo "scale=3; $ms/1000" | bc)
      elif [ "$op" = "emit" ]; then
        echo "$line" | jq -c '.event'
      fi
    done < "$SCENARIO_DIR/events.jsonl"
    ;;
  
  inspect)
    # Return inspect data for the given container ID
    container_id="$2"
    jq ".\"$container_id\"" "$SCENARIO_DIR/inspect.json"
    ;;
  
  *)
    echo "docker: unknown command: $1" >&2
    exit 1
    ;;
esac